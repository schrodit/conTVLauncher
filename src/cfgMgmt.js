"use strict";function deepCp(e){return JSON.parse(JSON.stringify(e))}Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),fs=require("fs"),crypto=require("crypto"),defaultCfg=require("./default.json");class cfgMgmt{constructor(e){this.aMgmt=e,this.home=this.aMgmt.home,this.cfgPath=this.home+"/.config/conTVLauncher",this.logger=this.aMgmt.logger,this.hiddenTiles=[],this.config=this.readCfg(),electron_1.ipcMain.on("get-cfg",e=>{e.returnValue=this.getCfg()}),electron_1.ipcMain.on("save-cfg",(e,t)=>{this.setCfg(t),this.writeCfg(),this.aMgmt.win.webContents.send("recieve-cfg",this.config)}),electron_1.ipcMain.on("settings-restore-cfg",e=>{e.returnValue=this.restoreDefaultCfg()}),electron_1.ipcMain.on("set-tiles",(e,t)=>{this.config.tiles=t}),electron_1.ipcMain.on("save-new-tile",(e,t)=>{this.addNewTile(t)})}getCfg(){return this.config}setCfg(e){this.checkConfig(e)&&(this.config=deepCp(e))}readCfg(){if(this.logger.info("Loading config ..."),fs.existsSync(this.home+"/.config")||fs.mkdirSync(this.home+"/.config"),fs.existsSync(this.home+"/.config/conTVLauncher")||fs.mkdirSync(this.home+"/.config/conTVLauncher"),fs.existsSync(this.home+"/.config/conTVLauncher/config.json")){let e=JSON.parse(fs.readFileSync(this.home+"/.config/conTVLauncher/config.json"));return e.tiles=this.setupTiles(e),e}{let e=defaultCfg;return e.tiles=this.setupTiles(e),this.writeCfg(deepCp(e)),e}}writeCfg(e){try{this.logger.info("Writing config to "+this.home+"/.config/conTVLauncher/config.json ...");let t;void 0===e?t=deepCp(this.config):(t=e,this.setCfg(e)),this.checkConfig(t)?(t.tiles=this.restoreHiddenTiles(t.tiles),t.tiles=this.removeSystemTiles(t.tiles),fs.writeFileSync(this.home+"/.config/conTVLauncher/config.json",t.prettyprint?JSON.stringify(t,null,1):JSON.stringify(t))):this.aMgmt.logger.error("Cannot write config, check config: \n"+JSON.stringify(t,null,1))}catch(e){this.aMgmt.logger.error(e),this.aMgmt.app.exit()}}addNewTile(e){try{let t=crypto.createHash("md5").update(e.title).digest("hex")+"."+e.img.name.split(".").pop(),i=null!==e.img?this.saveImg(t,e.img.path):"",s={title:e.title,cmd:e.cmd,type:e.type,img:i,container:0,show:!0,selected:!0};this.config.tiles[0].splice(0,0,s);for(let e=0;e<this.config.tiles.length;e++)for(let t=0;t<this.config.tiles[e].length;t++)this.config.tiles[e][t].selected&&(this.config.tiles[e][t].selected=!1);this.writeCfg(),this.aMgmt.win.webContents.send("recieve-cfg",this.config),this.aMgmt.extApp.appWin.webContents.send("recieve-cfg",this.config)}catch(e){this.logger.error(e)}}saveImg(e,t){try{let i=this.cfgPath+"/img";fs.existsSync(i)||fs.mkdirSync(i);let s=fs.readFileSync(t);return i=i+"/"+e,fs.writeFileSync(i,s),i}catch(e){this.aMgmt.throwError(e)}throw new Error("Cannot write file")}setupTiles(e){let t=e.tiles,i=[],s=0;return(t=this.addSystemTiles(e)).forEach((e,s)=>{e.forEach((e,n)=>{e.show?(e.container=s,e.selected=!1):(this.hiddenTiles.push({container:s,tile:n,data:t[s][n]}),i.push(n))}),i.forEach((e,i)=>{t[s].splice(e-i,1)}),i=[]}),t.forEach((e,i)=>{0===e.length&&(t.splice(i-s,1),s++)}),t}addSystemTiles(e){let t=e.tiles,i=[{title:"Settings",img:"icons:settings",type:"sys",cmd:"settings",show:!0},{title:"Close",img:"icons:close",type:"sys",cmd:"close",show:!0},{title:"Poweroff",img:"icons:settings-power",type:"sys",cmd:"shutdown",show:e.enableShutdown}];return t.push(i),t}removeSystemTiles(e){let t=0,i=e.length;for(let s=0;s<i;s++){let i=s-t,n=0,r=e[i].length;for(let s=0;s<r;s++){let r=s-n,o=e[i][r];if(null===o)throw new Error("Tile in "+i+". Container, "+i+". Tile is null\n"+JSON.stringify(e[i],null,1));"sys"===o.type&&this.isSystemTile(o.cmd)?(e[i].splice(r,1),n++,0===e[i].length&&(e.splice(i,1),t++)):(void 0!==e[i][r].container&&delete e[i][r].container,void 0!==e[i][r].selected&&delete e[i][r].selected)}}return e}isSystemTile(e){switch(e){case"shutdown":case"settings":case"close":return!0;default:return!1}}restoreHiddenTiles(e){return this.hiddenTiles.forEach(t=>{void 0!==e[t.container]&&e[t.container].length>0&&e[t.container][0].container===t.container?"sys"===t.data.type?e[e.length-1].splice(t.tile,0,t.data):e[t.container].splice(t.tile,0,t.data):(e.splice(t.container,0,[]),e[t.container].splice(t.tile,0,t.data))}),e}restoreDefaultCfg(){let e=defaultCfg;return e.tiles=this.setupTiles(defaultCfg),e}checkConfig(e){return void 0!==e&&!(Object.keys(e).length<6||e.constructor!==Object)}}exports.cfgMgmt=cfgMgmt;