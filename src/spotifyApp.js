"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),http=require("http"),url=require("url"),path=require("path"),SpotifyWebApi=require("spotify-web-api-node"),bigInteger=require("big-integer");class spotifyApp{constructor(t){this.aMgmt=t,this.track=null,this.status={status:"",position:0},this.connectWebAPI(),electron_1.ipcMain.on("spotify-open-menu",()=>{this.openMenu()}),electron_1.ipcMain.on("spotify-get-track",()=>{null!==this.track&&(this.sendTrack(),this.sendStatus())})}startServer(){http.createServer((t,e)=>{try{let e=url.parse(t.url,!0).query.t,s=JSON.parse(e);if(s.status){switch("seek"!==s.status&&(this.status.status=s.status),s.position>-1?this.status.position=s.position:void 0===this.status.position&&(this.status.position=0),this.status.status){case"play":this.startProgress();break;case"pause":clearInterval(this.progressInterval);break;case"stop":this.aMgmt.win.webContents.send("spotify-close")}this.sendStatus()}else this.track=s,this.track.id=this.convertBase(this.track.id),this.status.position=0,this.updateTrack()}catch(t){this.aMgmt.logger.error(t.message)}e.writeHead(200,{"Content-Type":"text/plain"}),e.end("success")}).listen(33003,"127.0.0.1").on("error",t=>{this.aMgmt.logger.error(t.message)}),this.aMgmt.logger.info("Spotify reciever running at http://127.0.0.1:33003/")}sendTrack(){this.aMgmt.extApp.appWin&&this.aMgmt.extApp.appWin.webContents.send("spotify-new-track",this.track),this.aMgmt.win.webContents.send("spotify-new-track",this.track)}sendStatus(){this.aMgmt.extApp.appWin&&this.aMgmt.extApp.appWin.webContents.send("spotify-new-status",this.status),this.aMgmt.win.webContents.send("spotify-new-status",this.status)}connectWebAPI(){this.spotifyApi=new SpotifyWebApi({clientId:"7d36823acef04cfc845c46d55cda553f",clientSecret:"03df9850d7a948f291e8a1a75d83c34a"})}updateTrack(){let t=this;this.spotifyApi.clientCredentialsGrant().then(function(e){t.aMgmt.logger.info("The access token expires in "+e.body.expires_in),t.spotifyApi.setAccessToken(e.body.access_token)}).then(()=>{t.spotifyApi.getTrack(t.track.id).then(function(e){t.track=e.body,t.sendTrack()}).catch(function(e){t.aMgmt.logger.error("Cannot update track: "+t.track.id+"; "+e)})}).catch(function(e){t.aMgmt.logger.error("Cannot update Acces token"+e)})}testTrack(){this.track=JSON.parse('{"album":{"cover":["ebfc209ba574ba05143f16bdd51d2b4988c21d18","d0dff35b4c4908f6429c76bae540aa1f4951e483","ad5f67e81158523b916d1981c9ae99684005d8d7"],"id":"f8533d8a681f4372902982e5774c1d16","name":"Narrenkoenig"},"artists":[{"id":"66e2807455334dfb97b5c7f3f65fe49b","name":"Schandmaul"}],"available":true,"id":"e067822a755e4c1385cde31fe8a35514","name":"Sonnenstrahl"}')}convertBase(t){const e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");let s=bigInteger(t,16).toString(62);if((s=s.replace(/<[0-9][0-9]>/g,t=>e[Number(t.replace(/<|>/g,""))])).length<22)for(let t=0;t<=22-s.length;t++)s="0"+s;return s}startProgress(){this.progressInterval=global.setInterval(()=>{this.status.position=this.status.position+1e3},1e3)}openMenu(){this.aMgmt.extApp.appWin=new electron_1.BrowserWindow({parent:this.aMgmt.win,show:!0,frame:!1,width:300,height:346,modal:!0}),this.aMgmt.extApp.appWin.loadURL(url.format({protocol:"file",slashes:!0,pathname:path.join(this.aMgmt.app.getAppPath(),"frontend/wrapper/spotify-settings.html")})),electron_1.ipcMain.on("spotify-action-close",()=>{this.aMgmt.win.webContents.send("spotify-close"),this.aMgmt.extApp.appWin.close()}),electron_1.ipcMain.on("spotify-action-disable",()=>{this.aMgmt.win.webContents.send("spotify-toggle-disabled"),this.aMgmt.extApp.appWin.close()}),this.aMgmt.extApp.appWin.on("ready-to-show",()=>{this.aMgmt.logger.info("Open spotify menu"),this.aMgmt.extApp.appWin.show()}),this.aMgmt.extApp.appWin.on("close",()=>{this.aMgmt.extApp.open=!1,this.aMgmt.extApp.type="",this.aMgmt.logger.info("Close web app ..."),this.aMgmt.extApp.appWin=null})}}exports.spotifyApp=spotifyApp;