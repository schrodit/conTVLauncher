"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),path=require("path"),url=require("url"),powerOff=require("power-off"),exec=require("child_process").exec;class extAppMgmt{constructor(t){this.aMgmt=t,this.open=!1,electron_1.ipcMain.on("open-App",(t,e)=>{try{this.openApp(e)}catch(t){this.aMgmt.throwError(t.message)}}),electron_1.ipcMain.on("close-App",t=>{try{this.closeApp()}catch(t){this.aMgmt.throwError(t.message)}}),electron_1.ipcMain.on("open-tile-editor",()=>{this.open||this.openTileEditorWin()})}openApp(t){switch(this.open&&this.closeApp(),this.type=t.type,this.type){case"web":this.cmd=t.cmd,this.newWebApp(this.cmd);break;case"shell":this.cmd=t.cmd,this.openExtApp();break;case"intern":this.cmd=t.cmd,this.newInternApp(this.cmd);break;case"sys":this.cmd=t.cmd,this.execSysApp();break;default:throw new Error("Unknown application type")}this.aMgmt.stopActive()}closeApp(){if(!this.appWin.isDestroyed())switch(this.type){case"web":case"shell":case"sys":case"intern":this.appWin.close();break;case"ext":this.closeExtApp();break;default:this.aMgmt.logger.error("Unkown application type "+this.type),this.type="",this.cmd=""}this.aMgmt.startActive()}newWebApp(t){this.appWin=new electron_1.BrowserWindow({parent:this.aMgmt.win,modal:!0,frame:!1,show:!1,fullscreen:!0,webPreferences:{plugins:!0,nodeIntegration:!1}}),this.appWin.loadURL(t),this.appWin.webContents.on("did-fail-load",(e,i,n)=>{throw"ERR_INTERNET_DISCONNECTED"===n?Error("No Internet connection"):Error("Failed connecting to "+t)}),this.appWin.on("app-command",(t,e)=>{"browser-backward"===e&&this.appWin.webContents.canGoBack()&&this.appWin.webContents.goBack();"browser-backward"!==e||this.appWin.webContents.canGoBack()||this.appWin.close()}),this.appWin.once("ready-to-show",()=>{this.aMgmt.logger.info("Open new Web Window with url: "+t);this.appWin.show();this.open=!0}),this.appWin.on("close",()=>{this.open=!1;this.type="";this.aMgmt.logger.info("Close web app ...");this.appWin=null}),this.aMgmt.stopActive()}newInternApp(t){this.appWin=new electron_1.BrowserWindow({parent:this.aMgmt.win,modal:!0,frame:!1,fullscreen:!0}),this.appWin.loadURL(url.format({protocol:"file",slashes:!0,pathname:path.join(this.aMgmt.app.getAppPath(),"frontend","wrapper",t)})),this.appWin.once("ready-to-show",()=>{this.aMgmt.logger.info("Open new Internal App Window");this.appWin.show();this.open=!0}),this.appWin.on("close",()=>{this.open=!1;this.type="";this.aMgmt.logger.info("Close web app ...");this.appWin=null}),this.aMgmt.stopActive()}openExtApp(){let t=this.aMgmt.app.getAppPath()+"/bin/startscript.sh start "+this.aMgmt.home+"/.config/conTVLauncher/extApp.pid "+this.cmd;require("child_process").exec(t),this.open=!0}closeExtApp(){let t=this.aMgmt.app.getAppPath()+"/bin/startscript.sh stop "+this.aMgmt.home+"/.config/conTVLauncher/extApp.pid "+this.cmd;require("child_process").execSync(t),this.open=!1,this.cmd=""}execSysApp(){switch(this.cmd){case"close":this.aMgmt.app.quit();break;case"shutdown":this.openPowerSettingsWin();break;case"settings":this.openSettingsWin();break;default:throw new Error("Unknown System App")}}openSettingsWin(){this.appWin=new electron_1.BrowserWindow({parent:this.aMgmt.win,show:!1,frame:!1,width:500,useContentSize:!0,modal:!0}),this.appWin.loadURL(url.format({protocol:"file",slashes:!0,pathname:path.join(this.aMgmt.app.getAppPath(),"frontend/wrapper/settings.html")})),this.appWin.on("ready-to-show",()=>{this.aMgmt.logger.info("Open settings window");this.appWin.show()}),electron_1.ipcMain.on("settings-save-cfg",(t,e)=>{this.aMgmt.cfg.setCfg(e);this.aMgmt.cfg.writeCfg();this.aMgmt.win.webContents.send("recieve-cfg",this.aMgmt.cfg.getCfg());this.appWin&&this.closeApp()}),this.appWin.on("close",()=>{electron_1.ipcMain.removeAllListeners("settings-save-cfg");this.open=!1;this.type="";this.aMgmt.logger.info("Close web app ...");this.appWin=null})}openTileEditorWin(){this.type="sys",this.open=!0,this.appWin=new electron_1.BrowserWindow({parent:this.aMgmt.win,show:!1,fullscreen:!0,modal:!0}),this.appWin.loadURL(url.format({protocol:"file",slashes:!0,pathname:path.join(this.aMgmt.app.getAppPath(),"frontend/wrapper/tileEditor.html")})),this.appWin.on("ready-to-show",()=>{this.aMgmt.logger.info("Open tile editor window");this.appWin.show()}),this.appWin.on("close",()=>{electron_1.ipcMain.removeAllListeners("save-tiles");this.open=!1;this.type="";this.aMgmt.logger.info("Close tile editor ...");this.appWin=null}),electron_1.ipcMain.on("save-tiles",(t,e)=>{let i=this.aMgmt.cfg.getCfg();i.tiles=e;this.aMgmt.cfg.writeCfg(i);this.aMgmt.win.webContents.send("recieve-cfg",this.aMgmt.cfg.getCfg())}),this.aMgmt.stopActive()}openPowerSettingsWin(){this.appWin=new electron_1.BrowserWindow({parent:this.aMgmt.win,show:!0,frame:!1,width:300,height:346,modal:!0}),this.appWin.loadURL(url.format({protocol:"file",slashes:!0,pathname:path.join(this.aMgmt.app.getAppPath(),"frontend/wrapper/powersettings.html")})),electron_1.ipcMain.on("power-shutdown",()=>{this.type="";this.cmd="";let t=this;powerOff((e,i,n)=>{if(e||i)throw new Error(i.toString());t.aMgmt.logger.info(n.toString())})}),electron_1.ipcMain.on("power-restart",()=>{let t=this;exec("reboot",(e,i,n)=>{if(e||i)throw new Error(i.toString());t.aMgmt.logger.info(n.toString())})}),electron_1.ipcMain.on("power-reload",()=>{this.aMgmt.app.relaunch();this.aMgmt.app.exit(0)}),this.appWin.on("ready-to-show",()=>{this.aMgmt.logger.info("Open power-settings window");this.appWin.show()}),this.appWin.on("close",()=>{this.open=!1;this.type="";this.aMgmt.logger.info("Close web app ...");this.appWin=null})}openScreensaver(){void 0!==this.screensaver&&null!==this.screensaver&&this.screensaver.close(),this.screensaver=new electron_1.BrowserWindow({parent:this.aMgmt.win,show:!0,frame:!1,fullscreen:!0,modal:!0}),this.screensaver.loadURL(url.format({protocol:"file",slashes:!0,pathname:path.join(this.aMgmt.app.getAppPath(),"frontend/wrapper/screensaver.html")})),this.screensaver.on("ready-to-show",()=>{this.aMgmt.win.hide();this.open&&"ext"!==this.type&&this.appWin.hide();this.aMgmt.logger.info("Open screensaver");this.screensaver.show()}),this.screensaver.on("close",()=>{this.aMgmt.win.show();this.open&&this.appWin.show();this.aMgmt.logger.info("Close screensaver");this.screensaver=null})}}exports.extAppMgmt=extAppMgmt;