"use strict";function deepCp(e){return JSON.parse(JSON.stringify(e))}Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),fs=require("fs"),crypto=require("crypto"),defaultCfg=require("./default.json");class cfgMgmt{constructor(e){this.aMgmt=e,this.home=this.aMgmt.home,this.cfgPath=this.home+"/.config/conTVLauncher",this.logger=this.aMgmt.logger,this.hiddenTiles=[],this.config=this.readCfg(),electron_1.ipcMain.on("get-cfg",e=>{e.returnValue=this.getCfg()}),electron_1.ipcMain.on("save-cfg",(e,t)=>{this.setCfg(t);this.writeCfg();this.aMgmt.win.webContents.send("recieve-cfg",this.config)}),electron_1.ipcMain.on("settings-restore-cfg",e=>{e.returnValue=this.restoreDefaultCfg()}),electron_1.ipcMain.on("set-tiles",(e,t)=>{this.config.tiles=t}),electron_1.ipcMain.on("get-hidden-tiles",e=>{e.returnValue=this.restoreHiddenTiles(this.getCfg().tiles)}),electron_1.ipcMain.on("save-new-tile",(e,t)=>{this.addNewTile(t)})}getCfg(){return this.config}setCfg(e){this.checkConfig(e)&&(this.config=deepCp(e))}readCfg(){if(this.logger.info("Loading config ..."),fs.existsSync(this.home+"/.config")||fs.mkdirSync(this.home+"/.config"),fs.existsSync(this.home+"/.config/conTVLauncher")||fs.mkdirSync(this.home+"/.config/conTVLauncher"),fs.existsSync(this.home+"/.config/conTVLauncher/config.json")){let e=JSON.parse(fs.readFileSync(this.home+"/.config/conTVLauncher/config.json"));return e.tiles=this.setupTiles(e),e}{let e=defaultCfg;return e.tiles=this.setupTiles(e),this.writeCfg(deepCp(e)),e}}writeCfg(e){this.logger.info("Writing config to "+this.home+"/.config/conTVLauncher/config.json ...");let t;void 0===e?t=deepCp(this.config):(t=e,this.setCfg(e)),this.checkConfig(t)?(t.tiles=this.restoreHiddenTiles(t.tiles),t.tiles=this.removeSystemTiles(t.tiles),fs.writeFileSync(this.home+"/.config/conTVLauncher/config.json",t.prettyprint?JSON.stringify(t,null,1):JSON.stringify(t))):this.aMgmt.logger.error("Cannot write config, check config: \n"+JSON.stringify(t,null,1))}addNewTile(e){try{let t=crypto.createHash("md5"),i=t.update(e.title).digest("hex")+"."+e.img.name.split(".").pop(),n=null!==e.img?this.saveImg(i,e.img.path):"",s={title:e.title,cmd:e.cmd,type:e.type,img:n,container:0,show:!0,selected:!0};this.config.tiles[0].splice(0,0,s);for(let e=0;e<this.config.tiles.length;e++)for(let t=0;t<this.config.tiles[e].length;t++)this.config.tiles[e][t].selected&&(this.config.tiles[e][t].selected=!1);this.writeCfg(),this.aMgmt.win.webContents.send("recieve-cfg",this.config),this.aMgmt.extApp.appWin.webContents.send("recieve-cfg",this.config)}catch(e){this.logger.error(e)}}saveImg(e,t){try{let i=this.cfgPath+"/img";fs.existsSync(i)||fs.mkdirSync(i);let n=fs.readFileSync(t);return i=i+"/"+e,fs.writeFileSync(i,n),i}catch(e){this.aMgmt.throwError(e)}throw new Error("Cannot write file")}setupTiles(e){let t=e.tiles,i=[];return(t=this.addSystemTiles(e)).forEach((e,n)=>{e.forEach((e,s)=>{e.show?(e.container=n,e.selected=!1):(this.hiddenTiles.push({container:n,tile:s,data:t[n][s]}),i.push(s))});i.forEach((e,i)=>{t[n].splice(e-i,1)});i=[]}),t}addSystemTiles(e){let t=e.tiles,i=[{title:"Settings",img:"icons:settings",type:"sys",cmd:"settings",show:!0},{title:"Close",img:"icons:close",type:"sys",cmd:"close",show:!0},{title:"Poweroff",img:"icons:settings-power",type:"sys",cmd:"shutdown",show:e.enableShutdown}];return t.push(i),t}removeSystemTiles(e){let t=0,i=e.length;for(let n=0;n<i;n++){let i=n-t,s=0,c=e[i].length;for(let n=0;n<c;n++){let c=n-s,o=e[i][c];"sys"===o.type&&this.isSystemTile(o.cmd)?(e[i].splice(c,1),s++,0===e[i].length&&(e.splice(i,1),t++)):(void 0!==e[i][c].container&&delete e[i][c].container,void 0!==e[i][c].selected&&delete e[i][c].selected)}}return e}isSystemTile(e){switch(e){case"shutdown":case"settings":case"close":return!0;default:return!1}}restoreHiddenTiles(e){return this.hiddenTiles.forEach(t=>{void 0!==e[t.container]&&e[t.container].length>0&&e[t.container][0].container===t.container?"sys"===t.data.type?e[e.length-1].splice(t.tile,0,t.data):e[t.container].splice(t.tile,0,t.data):(e.splice(t.container,0,[null]),e[t.container].splice(t.tile,0,t.data))}),e}restoreDefaultCfg(){let e=defaultCfg;return e.tiles=this.setupTiles(defaultCfg),e}checkConfig(e){return void 0!==e&&!(Object.keys(e).length<6||e.constructor!==Object)}}exports.cfgMgmt=cfgMgmt;